name: '[CD] Release ì‹œì‘ & ìŠ¬ë™ ì•Œë¦¼'

on:
  workflow_dispatch:
  workflow_run:
    workflows: ì •ê¸° ë¦´ë¦¬ì¦ˆ feat ì»¤ë°‹ ì¶”ê°€
    types:
      - completed

jobs:
  release-start:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      # ë¸Œëœì¹˜ ìµœì‹ í™”
      - name: Update remote branches
        run: git remote update

      - name: Update develop and master branch
        run: git checkout develop && git pull origin develop && git checkout master && git pull origin master

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18.20.0"

      - name: Set npm config
        run: |
          npm config set @goorm-dev:registry=https://npm.pkg.github.com/
          npm config set //npm.pkg.github.com/:_authToken ${{ secrets.PACKAGE_TOKEN }}

      - name: Set Git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Yarn
        run: |
          curl -L https://yarnpkg.com/install.sh | bash
          export PATH="$HOME/.local/bin:$PATH"
      
      - name: Install Dependencies
        run: yarn install:all

      - name: Install git flow
        run: |
          sudo apt-get update
          sudo apt-get install -y git-flow
          git flow init -d

      # ë¦´ë¦¬ì¦ˆ ë¸Œëœì¹˜ ì´ë¦„ ìƒì„± (ì˜ˆ: 20241112-0)
      - name: Get Release branch's name
        run: |
          TODAY_DATE=$(node -e 'const today = new Date(); console.log(`${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, "0")}${String(today.getDate()).padStart(2, "0")}`)')
          echo "RELEASE_BRANCH_NAME=${TODAY_DATE}-0" >> $GITHUB_ENV

      - name: Start Release with git flow and lerna version
        run: |
          # ë¦´ë¦¬ì¦ˆ ë¸Œëœì¹˜ ìƒì„±
          git flow release start -F ${{ env.RELEASE_BRANCH_NAME }}

          # ë¦´ë¦¬ì¦ˆ ë¸Œëœì¹˜ publish & lerna version
          yarn version:release

      # ì´ë²ˆ ìŠ¤í”„ë¦°íŠ¸ ì‘ì—… ë‚´ì—­ íŒŒì‹±(ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ë¥¼ ìœ„í•œ ë‚´ìš©)
      - name: Read the latest minor CHANGELOG entry
        run: |
          # ìµœê·¼ '##' í—¤ë”ë¶€í„° ì´ì „ '##' í—¤ë”ê¹Œì§€ ë‚´ìš©ì„ CHANGELOG.mdì—ì„œ ì¶”ì¶œ
          CHANGELOG=$(awk '/^## /{if (found) exit; found=1} found{print}' CHANGELOG.md)

          # ë§ˆí¬ë‹¤ìš´ íƒ€ì´í‹€ì„ Slackì—ì„œ êµµê²Œë¡œ ë³€í™˜
          CHANGELOG=$(echo "$CHANGELOG" | sed -E 's/^##+ (.+)/*\1*/')

          # ë§ˆí¬ë‹¤ìš´ URLì„ Slack í¬ë§· URLë¡œ ë³€í™˜
          CHANGELOG=$(echo "$CHANGELOG" | sed -E 's/\\?([[][^]]+]\\?)\\?[(]([^()]+)\\?[)]/<\2|\1>/g')

          # ìˆ˜ì •ëœ ë³€ê²½ë¡œê·¸ë¥¼ í™˜ê²½ íŒŒì¼ì— ì‘ì„±
          echo "CHANGELOG_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Get current package version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@v1.2.3
        with:
          path: packages/vapor-components

      - name: Send to Slack via Webhook
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          CHANGELOG_CONTENT: ${{ env.CHANGELOG_CONTENT }}
        run: |
          # JSON êµ¬ë¬¸ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë³€ê²½ë¡œê·¸ ë‚´ìš©ì˜ ì´ì¤‘ ë”°ì˜´í‘œë¥¼ ì´ìŠ¤ì¼€ì´í”„
          ESCAPED_CHANGELOG_CONTENT=$(echo "$CHANGELOG_CONTENT" | sed 's/\^H//g' | sed 's/"/\\"/g')

          echo "íŒŒì‹±ëœ CHANGELOG.md"
          echo "$ESCAPED_CHANGELOG_CONTENT"

          # ê²°í•©ëœ ë©”ì‹œì§€ë¥¼ Slackìœ¼ë¡œ ì „ì†¡
          curl -X POST --data-urlencode "payload={
            \"username\": \"release-bot\",
            \"blocks\": [
              {
                \"type\": \"header\",
                \"text\": {
                  \"type\": \"plain_text\",
                  \"text\": \"${{ steps.package-version.outputs.current-version }} ë¦´ë¦¬ì¦ˆ ì—´ì°¨ê°€ ì¶œë°œí•©ë‹ˆë‹¤ ğŸš‚\",
                  \"emoji\": true
                }
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"Vapor ${{ steps.package-version.outputs.current-version }} ë²„ì „ì˜ *ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸* ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš” \nì´ë²ˆ ìŠ¤í”„ë¦°íŠ¸ì— ë¦´ë¦¬ì¦ˆí•  *í”¼ê·¸ë§ˆ ë§í¬ë¥¼ ëŒ“ê¸€ì— ë‹¬ì•„ì£¼ì„¸ìš”*\"
                }
              },
              {
                \"type\": \"divider\"
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"<https://github.com/goorm-dev/gds/tree/release/${{env.RELEASE_BRANCH_NAME}}|release/${{env.RELEASE_BRANCH_NAME}}>\"
                }
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"${ESCAPED_CHANGELOG_CONTENT}\"
                }
              },
              {
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"> ë¦´ë¦¬ì¦ˆ í•­ëª©ì„ ëª¨ë‘ í™•ì¸í–ˆë‹¤ë©´, ì™„ë£Œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”\"
                }
              },
              {
                \"type\": \"actions\",
                \"elements\": [
                  {
                    \"type\": \"button\",
                    \"text\": {
                      \"type\": \"plain_text\",
                      \"text\": \"ì™„ë£Œ\",
                      \"emoji\": true
                    },
                    \"value\": \"complete_release\",
                    \"action_id\": \"complete_write_release_note\"
                  }
                ]
              }
            ]
          }" "${{ secrets.SLACK_WEBHOOK_URL }}"
